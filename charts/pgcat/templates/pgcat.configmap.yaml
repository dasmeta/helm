apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "base.fullname" . }}
data:
  pgcat.toml: |
    # PgCat Configuration File
    # Generated by Helm chart
    # See https://github.com/postgresml/pgcat/blob/main/CONFIG.md for documentation

    [general]
    host = {{ .Values.pgcat.app.general.host | quote }}
    port = {{ printf "%d" (int64 .Values.pgcat.app.general.port) }}
    enable_prometheus_exporter = {{ .Values.pgcat.app.general.enable_prometheus_exporter }}
    prometheus_exporter_port = {{ printf "%d" (int64 .Values.pgcat.app.general.prometheus_exporter_port) }}
    connect_timeout = {{ printf "%d" (int64 .Values.pgcat.app.general.connect_timeout) }}
    idle_timeout = {{ printf "%d" (int64 .Values.pgcat.app.general.idle_timeout) }}
    server_lifetime = {{ printf "%d" (int64 .Values.pgcat.app.general.server_lifetime) }}
    server_round_robin = {{ .Values.pgcat.app.general.server_round_robin }}
    server_tls = {{ .Values.pgcat.app.general.server_tls }}
    verify_server_certificate = {{ .Values.pgcat.app.general.verify_server_certificate }}
    verify_config = {{ .Values.pgcat.app.general.verify_config }}
    idle_client_in_transaction_timeout = {{ printf "%d" (int64 .Values.pgcat.app.general.idle_client_in_transaction_timeout) }}
    healthcheck_timeout = {{ printf "%d" (int64 .Values.pgcat.app.general.healthcheck_timeout) }}
    healthcheck_delay = {{ printf "%d" (int64 .Values.pgcat.app.general.healthcheck_delay) }}
    shutdown_timeout = {{ printf "%d" (int64 .Values.pgcat.app.general.shutdown_timeout) }}
    ban_time = {{ printf "%d" (int64 .Values.pgcat.app.general.ban_time) }}
    log_client_connections = {{ .Values.pgcat.app.general.log_client_connections }}
    log_client_disconnections = {{ .Values.pgcat.app.general.log_client_disconnections }}
    autoreload = {{ printf "%d" (int64 .Values.pgcat.app.general.autoreload) }}
    worker_threads = {{ printf "%d" (int64 .Values.pgcat.app.general.worker_threads) }}
    tcp_keepalives_idle = {{ printf "%d" (int64 .Values.pgcat.app.general.tcp_keepalives_idle) }}
    tcp_keepalives_count = {{ printf "%d" (int64 .Values.pgcat.app.general.tcp_keepalives_count) }}
    tcp_keepalives_interval = {{ printf "%d" (int64 .Values.pgcat.app.general.tcp_keepalives_interval) }}
    tcp_user_timeout = {{ printf "%d" (int64 .Values.pgcat.app.general.tcp_user_timeout) }}
    {{- if and .Values.pgcat.app.general.tls_certificate (ne .Values.pgcat.app.general.tls_certificate "") }}
    tls_certificate = {{ .Values.pgcat.app.general.tls_certificate | quote }}
    {{- end }}
    {{- if and .Values.pgcat.app.general.tls_private_key (ne .Values.pgcat.app.general.tls_private_key "") }}
    tls_private_key = {{ .Values.pgcat.app.general.tls_private_key | quote }}
    {{- end }}
    admin_username = {{ .Values.pgcat.app.general.admin_username | quote }}
    admin_password = {{ .Values.pgcat.app.general.admin_password | quote }}
    {{- if and .Values.pgcat.app.general.auth_query (ne .Values.pgcat.app.general.auth_query "") }}
    auth_query = {{ .Values.pgcat.app.general.auth_query | quote }}
    {{- end }}
    {{- if and .Values.pgcat.app.general.auth_query_user (ne .Values.pgcat.app.general.auth_query_user "") }}
    auth_query_user = {{ .Values.pgcat.app.general.auth_query_user | quote }}
    {{- end }}
    {{- if and .Values.pgcat.app.general.auth_query_password (ne .Values.pgcat.app.general.auth_query_password "") }}
    auth_query_password = {{ .Values.pgcat.app.general.auth_query_password | quote }}
    {{- end }}
    dns_cache_enabled = {{ .Values.pgcat.app.general.dns_cache_enabled }}
    dns_max_ttl = {{ printf "%d" (int64 .Values.pgcat.app.general.dns_max_ttl) }}
    prepared_statements_cache_size = {{ printf "%d" (int64 .Values.pgcat.app.general.prepared_statements_cache_size) }}

    {{- if .Values.pgcat.app.pools }}
    {{- range $poolName, $pool := .Values.pgcat.app.pools }}
    [pools.{{ $poolName }}]
    {{- if $pool.pool_mode }}
    pool_mode = {{ $pool.pool_mode | quote }}
    {{- end }}
    {{- if $pool.load_balancing_mode }}
    load_balancing_mode = {{ $pool.load_balancing_mode | quote }}
    {{- end }}
    {{- if $pool.checkout_failure_limit }}
    checkout_failure_limit = {{ printf "%d" (int64 $pool.checkout_failure_limit) }}
    {{- end }}
    {{- if $pool.default_role }}
    default_role = {{ $pool.default_role | quote }}
    {{- end }}
    {{- if $pool.db_activity_based_routing }}
    db_activity_based_routing = {{ $pool.db_activity_based_routing }}
    {{- end }}
    {{- if $pool.db_activity_based_ms_init_delay }}
    db_activity_based_ms_init_delay = {{ printf "%d" (int64 $pool.db_activity_based_ms_init_delay) }}
    {{- end }}
    {{- if $pool.db_activity_ttl }}
    db_activity_ttl = {{ printf "%d" (int64 $pool.db_activity_ttl) }}
    {{- end }}
    {{- if $pool.table_mutation_cache_ms_ttl }}
    table_mutation_cache_ms_ttl = {{ printf "%d" (int64 $pool.table_mutation_cache_ms_ttl) }}
    {{- end }}
    {{- if $pool.query_parser_enabled }}
    query_parser_enabled = {{ $pool.query_parser_enabled }}
    {{- end }}
    {{- if $pool.primary_reads_enabled }}
    primary_reads_enabled = {{ $pool.primary_reads_enabled }}
    {{- end }}
    {{- if and $pool.sharding_key_regex (ne $pool.sharding_key_regex "") }}
    sharding_key_regex = {{ $pool.sharding_key_regex | quote }}
    {{- end }}
    {{- if $pool.sharding_function }}
    sharding_function = {{ $pool.sharding_function | quote }}
    {{- end }}
    {{- if and $pool.auth_query (ne $pool.auth_query "") }}
    auth_query = {{ $pool.auth_query | quote }}
    {{- end }}
    {{- if and $pool.auth_query_user (ne $pool.auth_query_user "") }}
    auth_query_user = {{ $pool.auth_query_user | quote }}
    {{- end }}
    {{- if and $pool.auth_query_password (ne $pool.auth_query_password "") }}
    auth_query_password = {{ $pool.auth_query_password | quote }}
    {{- end }}
    {{- if and $pool.automatic_sharding_key (ne $pool.automatic_sharding_key "") }}
    automatic_sharding_key = {{ $pool.automatic_sharding_key | quote }}
    {{- end }}
    {{- if $pool.idle_timeout }}
    idle_timeout = {{ printf "%d" (int64 $pool.idle_timeout) }}
    {{- end }}
    {{- if $pool.connect_timeout }}
    connect_timeout = {{ printf "%d" (int64 $pool.connect_timeout) }}
    {{- end }}

    {{- if $pool.users }}
    {{- range $userIndex, $user := $pool.users }}
    [pools.{{ $poolName }}.users.{{ $userIndex }}]
    username = {{ $user.username | quote }}
    password = {{ $user.password | quote }}
    {{- if and $user.server_username (ne $user.server_username "") }}
    server_username = {{ $user.server_username | quote }}
    {{- end }}
    {{- if and $user.server_password (ne $user.server_password "") }}
    server_password = {{ $user.server_password | quote }}
    {{- end }}
    {{- if $user.pool_size }}
    pool_size = {{ printf "%d" (int64 $user.pool_size) }}
    {{- end }}
    {{- if $user.min_pool_size }}
    min_pool_size = {{ printf "%d" (int64 $user.min_pool_size) }}
    {{- end }}
    {{- if $user.statement_timeout }}
    statement_timeout = {{ printf "%d" (int64 $user.statement_timeout) }}
    {{- end }}
    {{- if and $user.connect_timeout (ne $user.connect_timeout "") }}
    connect_timeout = {{ printf "%d" (int64 $user.connect_timeout) }}
    {{- end }}
    {{- end }}
    {{- end }}

    {{- if $pool.shards }}
    {{- range $shardIndex, $shard := $pool.shards }}
    [pools.{{ $poolName }}.shards.{{ $shardIndex }}]
    database = {{ $shard.database | quote }}
    servers = {{ $shard.servers | toJson }}
    {{- if $shard.mirrors }}
    mirrors = {{ $shard.mirrors | toJson }}
    {{- end }}
    {{- end }}
    {{- end }}

    {{- end }}
    {{- end }}
